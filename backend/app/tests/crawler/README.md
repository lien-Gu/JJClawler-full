# çˆ¬è™«æ¨¡å—æµ‹è¯•è¯´æ˜

è¿™ä¸ªç›®å½•åŒ…å«äº†æ™‹æ±Ÿæ–‡å­¦åŸçˆ¬è™«æ¨¡å—çš„å®Œæ•´æµ‹è¯•å¥—ä»¶ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
tests/crawler/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ conftest.py                    # æµ‹è¯•é…ç½®å’Œæ•°æ®fixtures
â”œâ”€â”€ pytest.ini                    # pytesté…ç½®æ–‡ä»¶
â”œâ”€â”€ README.md                      # æœ¬è¯´æ˜æ–‡ä»¶
â”œâ”€â”€ test_crawler_base.py          # çˆ¬è™«åŸºç¡€æ¨¡å—æµ‹è¯•
â”œâ”€â”€ test_jiazi_crawler.py         # å¤¹å­æ¦œçˆ¬è™«æµ‹è¯•
â”œâ”€â”€ test_page_crawler.py          # åˆ†ç±»é¡µé¢çˆ¬è™«æµ‹è¯•
â”œâ”€â”€ test_parser.py                # æ•°æ®è§£æå™¨æµ‹è¯•
â””â”€â”€ test_integration_real.py      # çœŸå®URLé›†æˆæµ‹è¯•
```

## ğŸ§ª æµ‹è¯•ç±»å‹

### å•å…ƒæµ‹è¯• (unit)
- **test_crawler_base.py**: æµ‹è¯•åŸºç¡€å·¥å…·å‡½æ•°
- **test_parser.py**: æµ‹è¯•æ•°æ®è§£æé€»è¾‘
- **test_jiazi_crawler.py**: æµ‹è¯•å¤¹å­æ¦œçˆ¬è™«ï¼ˆmockç½‘ç»œï¼‰
- **test_page_crawler.py**: æµ‹è¯•åˆ†ç±»é¡µé¢çˆ¬è™«ï¼ˆmockç½‘ç»œï¼‰

### é›†æˆæµ‹è¯• (integration)
- **test_integration_real.py**: ä½¿ç”¨çœŸå®APIçš„é›†æˆæµ‹è¯•

### ç½‘ç»œæµ‹è¯• (network)
- éœ€è¦çœŸå®ç½‘ç»œè¿æ¥çš„æµ‹è¯•
- é»˜è®¤è¢«è·³è¿‡ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡å¯ç”¨

## ğŸš€ è¿è¡Œæµ‹è¯•

### åŸºæœ¬ç”¨æ³•

```bash
# è¿è¡Œæ‰€æœ‰çˆ¬è™«æµ‹è¯•
pytest tests/crawler/ -v

# åªè¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆä¸éœ€è¦ç½‘ç»œï¼‰
pytest tests/crawler/ -m "unit" -v

# è·³è¿‡ç½‘ç»œæµ‹è¯•
pytest tests/crawler/ -m "not network" -v

# è¿è¡Œç‰¹å®šæ–‡ä»¶çš„æµ‹è¯•
pytest tests/crawler/test_parser.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/crawler/test_parser.py::TestJiaziDataParsing::test_parse_jiazi_data_success -v
```

### å¯ç”¨çœŸå®ç½‘ç»œæµ‹è¯•

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡å¯ç”¨ç½‘ç»œæµ‹è¯•
export ENABLE_REAL_NETWORK_TESTS=true

# åªè¿è¡Œç½‘ç»œæµ‹è¯•
pytest tests/crawler/test_integration_real.py -m network -v

# è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆåŒ…æ‹¬ç½‘ç»œæµ‹è¯•ï¼‰
pytest tests/crawler/ -v
```

### æµ‹è¯•æŠ¥å‘Š

```bash
# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest tests/crawler/ --cov=app.modules.crawler --cov-report=html

# ç”ŸæˆJUnit XMLæŠ¥å‘Š
pytest tests/crawler/ --junitxml=test-results.xml

# è¯¦ç»†è¾“å‡º
pytest tests/crawler/ -vv --tb=long
```

## ğŸ“Š æµ‹è¯•æ•°æ®

### conftest.py æä¾›çš„ Fixtures

- **real_urls_config**: çœŸå®çš„URLé…ç½®æ•°æ®
- **mock_urls_config**: æ¨¡æ‹Ÿçš„URLé…ç½®æ•°æ®
- **sample_jiazi_response_data**: å¤¹å­æ¦œAPIå“åº”ç¤ºä¾‹
- **sample_page_response_data**: åˆ†ç±»é¡µé¢APIå“åº”ç¤ºä¾‹
- **book_url_test_cases**: URLè§£ææµ‹è¯•ç”¨ä¾‹
- **numeric_field_test_cases**: æ•°å€¼å­—æ®µè§£ææµ‹è¯•ç”¨ä¾‹
- **mock_http_client**: æ¨¡æ‹Ÿçš„HTTPå®¢æˆ·ç«¯
- **mock_data_parser**: æ¨¡æ‹Ÿçš„æ•°æ®è§£æå™¨

### æµ‹è¯•æ ‡è®°

- `@pytest.mark.unit`: å•å…ƒæµ‹è¯•
- `@pytest.mark.integration`: é›†æˆæµ‹è¯•
- `@pytest.mark.network`: ç½‘ç»œæµ‹è¯•
- `@pytest.mark.slow`: æ…¢é€Ÿæµ‹è¯•

## ğŸ”§ æµ‹è¯•é…ç½®

### ç¯å¢ƒå˜é‡

- `ENABLE_REAL_NETWORK_TESTS`: å¯ç”¨çœŸå®ç½‘ç»œæµ‹è¯• (true/false)

### pytest é…ç½®

pytest.ini æ–‡ä»¶åŒ…å«äº†ï¼š
- æµ‹è¯•æ ‡è®°å®šä¹‰
- è¾“å‡ºæ ¼å¼é…ç½®
- æ—¥å¿—é…ç½®
- è­¦å‘Šè¿‡æ»¤

## ğŸ“‹ æµ‹è¯•è¦†ç›–

### çˆ¬è™«åŸºç¡€æ¨¡å— (base.py)
- âœ… é…ç½®ç®¡ç†
- âœ… æ•°æ®éªŒè¯
- âœ… URLå·¥å…·å‡½æ•°
- âœ… çˆ¬è™«ç»Ÿè®¡

### å¤¹å­æ¦œçˆ¬è™« (jiazi_crawler.py)
- âœ… åˆå§‹åŒ–å’Œé…ç½®
- âœ… æ•°æ®çˆ¬å–é€»è¾‘
- âœ… é”™è¯¯å¤„ç†
- âœ… èµ„æºç®¡ç†

### åˆ†ç±»é¡µé¢çˆ¬è™« (page_crawler.py)
- âœ… URLæ„å»º
- âœ… å¤šé¢‘é“æ”¯æŒ
- âœ… é¡µé¢ç»“æ„å¤„ç†
- âœ… é¢‘é“é…ç½®ç®¡ç†

### æ•°æ®è§£æå™¨ (parser.py)
- âœ… å¤¹å­æ¦œæ•°æ®è§£æ
- âœ… åˆ†ç±»é¡µé¢æ•°æ®è§£æ
- âœ… æ•°å€¼å­—æ®µå¤„ç†
- âœ… å¼‚å¸¸æ•°æ®å¤„ç†

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç½‘ç»œæµ‹è¯•**: çœŸå®ç½‘ç»œæµ‹è¯•ä¼šè®¿é—®æ™‹æ±Ÿæ–‡å­¦åŸçš„å®é™…APIï¼Œè¯·ï¼š
   - éµå®ˆç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾
   - æ§åˆ¶è¯·æ±‚é¢‘ç‡ï¼Œé¿å…è¿‡äºé¢‘ç¹
   - åœ¨å¼€å‘ç¯å¢ƒä¸­è°¨æ…ä½¿ç”¨

2. **æµ‹è¯•æ•°æ®**: ç¤ºä¾‹æ•°æ®åŸºäºçœŸå®APIå“åº”ç»“æ„ï¼Œä½†åŒ…å«æ¨¡æ‹Ÿå†…å®¹

3. **Mockä½¿ç”¨**: å•å…ƒæµ‹è¯•ä½¿ç”¨mocké¿å…ç½‘ç»œä¾èµ–ï¼Œç¡®ä¿æµ‹è¯•ç¨³å®šæ€§

4. **CI/CD**: åœ¨æŒç»­é›†æˆä¸­å»ºè®®è·³è¿‡ç½‘ç»œæµ‹è¯•ï¼Œåªåœ¨å¿…è¦æ—¶æ‰‹åŠ¨è¿è¡Œ

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ImportError**: ç¡®ä¿Pythonè·¯å¾„æ­£ç¡®ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œæµ‹è¯•
2. **ç½‘ç»œè¶…æ—¶**: æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–ç¦ç”¨ç½‘ç»œæµ‹è¯•
3. **é…ç½®æ–‡ä»¶ç¼ºå¤±**: ç¡®ä¿ `data/urls.json` æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®

### è°ƒè¯•æŠ€å·§

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
pytest tests/crawler/ -v -s --log-cli-level=DEBUG

# åœ¨ç¬¬ä¸€ä¸ªå¤±è´¥å¤„åœæ­¢
pytest tests/crawler/ -x

# é‡æ–°è¿è¡Œå¤±è´¥çš„æµ‹è¯•
pytest tests/crawler/ --lf
```

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•

éƒ¨åˆ†æµ‹è¯•åŒ…å«æ€§èƒ½éªŒè¯ï¼š
- HTTPå®¢æˆ·ç«¯å“åº”æ—¶é—´
- æ•°æ®è§£ææ•ˆç‡
- å¹¶å‘è¯·æ±‚å¤„ç†

## ğŸ”„ æŒç»­æ”¹è¿›

æµ‹è¯•å¥—ä»¶ä¼šéšç€çˆ¬è™«æ¨¡å—çš„å‘å±•æŒç»­æ›´æ–°ï¼š
- æ–°å¢APIæ”¯æŒæ—¶æ·»åŠ ç›¸åº”æµ‹è¯•
- ä¼˜åŒ–æµ‹è¯•æ•°æ®å’Œç”¨ä¾‹
- æ”¹è¿›æµ‹è¯•è¦†ç›–ç‡å’Œè´¨é‡